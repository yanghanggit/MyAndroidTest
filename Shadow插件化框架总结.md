# Shadow 插件化框架总结

## 什么是 Shadow

Shadow 是腾讯开源的 Android 插件化框架，主要用于动态加载和运行插件 APK。

## 核心特点

### 1. 编译期处理

- Shadow 在编译期通过 Gradle Transform 修改插件代码
- 将 Activity 等组件转换为普通类
- 不需要运行时 Hook 系统 API，更加稳定可靠

### 2. 零反射调用

- 不使用反射调用系统隐藏 API
- 更好地兼容 Android 高版本和不同厂商的系统

### 3. 架构设计

- **Manager（管理层）**：负责插件的安装、加载、更新
- **Host（宿主）**：原始应用程序
- **Plugin（插件）**：动态加载的业务模块
- **Runtime（运行时）**：插件运行环境，提供容器支持

### 4. 组件代理机制

- 插件中的 Activity 会被转换成 `ShadowActivity`
- 通过 ContainerActivity 作为壳来运行插件中的业务逻辑
- 其他组件如 Service、Provider 也有类似处理

## 主要优势

- **稳定性高**：不依赖系统反射和 Hook，不易受系统版本影响
- **性能好**：编译期处理，运行时开销小
- **维护性强**：代码清晰，易于理解和维护
- **支持完善**：支持大部分 Android 组件和特性

## 应用场景

- 业务模块动态更新
- 按需加载降低包体积
- 模块化开发和独立发布
- A/B 测试和灰度发布

---

## 动态加载插件 APK 详解

### 运行流程

```text
1. 宿主 APP（apk1）运行中
   ↓
2. 从服务器下载插件 APK（apk2）到本地
   → 保存到 app 私有目录（如 /data/data/包名/files/）
   ↓
3. 宿主 APP 调用 Shadow SDK 加载本地插件 APK
   → 解析插件的类、资源、so 库等
   ↓
4. 用户触发操作启动插件功能
   → 插件代码在宿主进程中执行
```

### 关键要点

#### 插件不会被安装到系统

- 插件 APK 只是一个文件，不通过 PackageManager 安装
- 系统不知道这个插件的存在
- 不会在桌面显示图标（除非宿主提供入口）

#### 插件运行在宿主进程中

- 插件的代码通过 ClassLoader 动态加载
- 插件和宿主共享同一个进程空间
- 插件可以访问宿主提供的接口和服务

#### 实际例子

```text
微信（宿主 APP）
  ↓
下载小程序包（插件 APK）
  ↓
打开小程序时动态加载
  ↓
小程序在微信进程中运行
```

### 优势

- 无需重新安装整个 APP，快速更新业务模块
- 按需下载，减少初始包体积
- 可以随时卸载插件释放空间

---

## Shadow 支持的组件类型

### 插件可以包含的组件

#### 1. Activity

- 最常用的插件组件
- 提供完整的生命周期支持
- 可以正常使用 Intent、回调等

#### 2. Service

- 支持后台服务
- 可以启动插件中的 Service
- 支持绑定和非绑定模式

#### 3. BroadcastReceiver

- 支持动态注册的广播接收器
- 静态注册的支持程度取决于框架实现

#### 4. ContentProvider

- 部分插件化框架支持
- 可能有一些限制

#### 5. Fragment

- 完全支持
- 作为 Activity 的一部分使用

#### 6. 普通类（业务逻辑）

```kotlin
// 插件中的普通工具类、管理类等
class PluginUtils {
    fun doSomething() {
        // 业务逻辑
    }
}

// 宿主可以直接调用
val utils = PluginUtils()
utils.doSomething()
```

### 使用场景示例

```text
用户操作 → 启动插件 Activity（界面）
         → 启动插件 Service（后台任务）
         → 调用插件工具类（纯逻辑）
         → 加载插件资源（图片、字符串等）
```

### 核心思想

**插件是一个完整的代码模块**，不仅仅是 Activity，可以包含任何 Android 组件和业务代码。宿主只需要一个入口来触发插件的加载和使用，这个入口可以是任何形式。

---

## 与其他插件化方案对比

相比其他插件化方案（如 VirtualAPK、RePlugin），Shadow 更注重：

- **稳定性**：编译期处理，避免运行时风险
- **可维护性**：代码结构清晰，易于理解
- **长期支持**：更好地适配 Android 系统演进

---
